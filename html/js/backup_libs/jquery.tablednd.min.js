/**
 * TableDnD plug-in for JQuery, allows you to drag and drop table rows
 * You can set up various options to control how the system will work
 * Copyright (c) Denis Howlett <denish@isocra.com>
 * Licensed like jQuery, see http://docs.jquery.com/License.
 *
 * https://github.com/isocra/TableDnD
 */
var hasTouch="ontouchstart"in document.documentElement,startEvent=hasTouch?"touchstart":"mousedown",moveEvent=hasTouch?"touchmove":"mousemove",endEvent=hasTouch?"touchend":"mouseup";hasTouch&&($.each(["touchstart","touchmove","touchend"],function(a,b){jQuery.event.fixHooks[b]=jQuery.event.mouseHooks}),alert("has Touch"));
jQuery.tableDnD={currentTable:null,dragObject:null,mouseOffset:null,oldY:0,build:function(a){this.each(function(){this.tableDnDConfig=jQuery.extend({onDragStyle:null,onDropStyle:null,onDragClass:"tDnD_whileDrag",onDrop:null,onDragStart:null,scrollAmount:5,serializeRegexp:/[^\-]*$/,serializeParamName:null,dragHandle:null},a||{});jQuery.tableDnD.makeDraggable(this)});return this},makeDraggable:function(a){var b=a.tableDnDConfig;b.dragHandle?jQuery(a.tableDnDConfig.dragHandle,a).each(function(){jQuery(this).bind(startEvent,
function(c){jQuery.tableDnD.initialiseDrag(jQuery(this).parents("tr")[0],a,this,c,b);return false})}):jQuery("tr",a).each(function(){var c=jQuery(this);c.hasClass("nodrag")||c.bind(startEvent,function(c){if(c.target.tagName=="TD"){jQuery.tableDnD.initialiseDrag(this,a,this,c,b);return false}}).css("cursor","move")})},initialiseDrag:function(a,b,c,e,d){jQuery.tableDnD.dragObject=a;jQuery.tableDnD.currentTable=b;jQuery.tableDnD.mouseOffset=jQuery.tableDnD.getMouseOffset(c,e);jQuery.tableDnD.originalOrder=
jQuery.tableDnD.serialize();jQuery(document).bind(moveEvent,jQuery.tableDnD.mousemove).bind(endEvent,jQuery.tableDnD.mouseup);if(d.onDragStart)d.onDragStart(b,c)},updateTables:function(){this.each(function(){this.tableDnDConfig&&jQuery.tableDnD.makeDraggable(this)})},mouseCoords:function(a){return a.pageX||a.pageY?{x:a.pageX,y:a.pageY}:{x:a.clientX+document.body.scrollLeft-document.body.clientLeft,y:a.clientY+document.body.scrollTop-document.body.clientTop}},getMouseOffset:function(a,b){var b=b||
window.event,c=this.getPosition(a),e=this.mouseCoords(b);return{x:e.x-c.x,y:e.y-c.y}},getPosition:function(a){var b=0,c=0;if(a.offsetHeight==0)a=a.firstChild;for(;a.offsetParent;){b=b+a.offsetLeft;c=c+a.offsetTop;a=a.offsetParent}b=b+a.offsetLeft;c=c+a.offsetTop;return{x:b,y:c}},mousemove:function(a){if(jQuery.tableDnD.dragObject!=null){a.type=="touchmove"&&event.preventDefault();var b=jQuery(jQuery.tableDnD.dragObject),c=jQuery.tableDnD.currentTable.tableDnDConfig,e=jQuery.tableDnD.mouseCoords(a),
a=e.y-jQuery.tableDnD.mouseOffset.y,d=window.pageYOffset;if(document.all)if(typeof document.compatMode!="undefined"&&document.compatMode!="BackCompat")d=document.documentElement.scrollTop;else if(typeof document.body!="undefined")d=document.body.scrollTop;e.y-d<c.scrollAmount?window.scrollBy(0,-c.scrollAmount):(window.innerHeight?window.innerHeight:document.documentElement.clientHeight?document.documentElement.clientHeight:document.body.clientHeight)-(e.y-d)<c.scrollAmount&&window.scrollBy(0,c.scrollAmount);
if(a!=jQuery.tableDnD.oldY){e=a>jQuery.tableDnD.oldY;jQuery.tableDnD.oldY=a;c.onDragClass?b.addClass(c.onDragClass):b.css(c.onDragStyle);(b=jQuery.tableDnD.findDropTargetRow(b,a))&&(e&&jQuery.tableDnD.dragObject!=b?jQuery.tableDnD.dragObject.parentNode.insertBefore(jQuery.tableDnD.dragObject,b.nextSibling):!e&&jQuery.tableDnD.dragObject!=b&&jQuery.tableDnD.dragObject.parentNode.insertBefore(jQuery.tableDnD.dragObject,b))}return false}},findDropTargetRow:function(a,b){for(var c=jQuery.tableDnD.currentTable.rows,
e=0;e<c.length;e++){var d=c[e],f=this.getPosition(d).y,g=parseInt(d.offsetHeight)/2;if(d.offsetHeight==0){f=this.getPosition(d.firstChild).y;g=parseInt(d.firstChild.offsetHeight)/2}if(b>f-g&&b<f+g){if(d==a)break;c=jQuery.tableDnD.currentTable.tableDnDConfig;if(c.onAllowDrop){if(!c.onAllowDrop(a,d))break}else if(jQuery(d).hasClass("nodrop"))break;return d}}return null},mouseup:function(){if(jQuery.tableDnD.currentTable&&jQuery.tableDnD.dragObject){jQuery(document).unbind(moveEvent,jQuery.tableDnD.mousemove).unbind(endEvent,
jQuery.tableDnD.mouseup);var a=jQuery.tableDnD.dragObject,b=jQuery.tableDnD.currentTable.tableDnDConfig;b.onDragClass?jQuery(a).removeClass(b.onDragClass):jQuery(a).css(b.onDropStyle);jQuery.tableDnD.dragObject=null;var c=jQuery.tableDnD.serialize();if(b.onDrop&&jQuery.tableDnD.originalOrder!=c)b.onDrop(jQuery.tableDnD.currentTable,a);jQuery.tableDnD.currentTable=null}},serialize:function(){return jQuery.tableDnD.currentTable?jQuery.tableDnD.serializeTable(jQuery.tableDnD.currentTable):"Error: No Table id set, you need to set an id on your table and every row"},
serializeTable:function(a){for(var b="",c=a.id,e=a.rows,d=0;d<e.length;d++){b.length>0&&(b=b+"&");var f=e[d].id;f&&f&&a.tableDnDConfig&&a.tableDnDConfig.serializeRegexp&&(f=f.match(a.tableDnDConfig.serializeRegexp)[0]);b=b+(c+"[]="+f)}return b},serializeTables:function(){var a="";this.each(function(){a=a+jQuery.tableDnD.serializeTable(this)});return a}};jQuery.fn.extend({tableDnD:jQuery.tableDnD.build,tableDnDUpdate:jQuery.tableDnD.updateTables,tableDnDSerialize:jQuery.tableDnD.serializeTables});
